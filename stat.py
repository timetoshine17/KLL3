# -*- coding: utf-8 -*-
import re
import torch
import pandas as pd

# 1) ---------------------------------------------------------------
#    ì „ì²´ ë¡œê·¸ë¥¼ "log" ë¬¸ìì—´ì— ë‹´ìŠµë‹ˆë‹¤.
log = """
ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20210602.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.5499, 0.5474, 0.6380],
        [0.5499, 1.0000, 0.7004, 0.5588],
        [0.5474, 0.7004, 1.0000, 0.5953],
        [0.6380, 0.5588, 0.5953, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20210603.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6333, 0.5252, 0.7351, 0.5960],
        [0.6333, 1.0000, 0.6580, 0.7359, 0.5070],
        [0.5252, 0.6580, 1.0000, 0.5580, 0.5298],
        [0.7351, 0.7359, 0.5580, 1.0000, 0.6769],
        [0.5960, 0.5070, 0.5298, 0.6769, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20210902.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.7017, 0.6264, 0.6004],
        [0.7017, 1.0000, 0.7683, 0.6841],
        [0.6264, 0.7683, 1.0000, 0.6908],
        [0.6004, 0.6841, 0.6908, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20210903.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.5376, 0.6235, 0.6238, 0.5000],
        [0.5376, 1.0000, 0.7268, 0.6983, 0.6207],
        [0.6235, 0.7268, 1.0000, 0.6924, 0.6008],
        [0.6238, 0.6983, 0.6924, 1.0000, 0.7462],
        [0.5000, 0.6207, 0.6008, 0.7462, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20211102.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.5749, 0.6645, 0.6525, 0.5656],
        [0.5749, 1.0000, 0.7127, 0.5648, 0.6301],
        [0.6645, 0.7127, 1.0000, 0.7252, 0.6298],
        [0.6525, 0.5648, 0.7252, 1.0000, 0.7440],
        [0.5656, 0.6301, 0.6298, 0.7440, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20211103.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.5239, 0.5778, 0.5195],
        [0.5239, 1.0000, 0.6000, 0.4583],
        [0.5778, 0.6000, 1.0000, 0.5864],
        [0.5195, 0.4583, 0.5864, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20220602.txt
âœ… ë¬¸ì¥ ìˆ˜: 3
âœ… ì„ë² ë”© shape: torch.Size([3, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6510, 0.6814],
        [0.6510, 1.0000, 0.6705],
        [0.6814, 0.6705, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20220603.txt
âœ… ë¬¸ì¥ ìˆ˜: 6
âœ… ì„ë² ë”© shape: torch.Size([6, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6064, 0.5686, 0.5245, 0.5152, 0.4896],
        [0.6064, 1.0000, 0.7642, 0.6775, 0.6859, 0.5899],
        [0.5686, 0.7642, 1.0000, 0.7131, 0.7359, 0.6306],
        [0.5245, 0.6775, 0.7131, 1.0000, 0.5579, 0.4247],
        [0.5152, 0.6859, 0.7359, 0.5579, 1.0000, 0.5424],
        [0.4896, 0.5899, 0.6306, 0.4247, 0.5424, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20220901.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6047, 0.4330, 0.5422, 0.7030],
        [0.6047, 1.0000, 0.6975, 0.7742, 0.8131],
        [0.4330, 0.6975, 1.0000, 0.6537, 0.5976],
        [0.5422, 0.7742, 0.6537, 1.0000, 0.6262],
        [0.7030, 0.8131, 0.5976, 0.6262, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20220903.txt
âœ… ë¬¸ì¥ ìˆ˜: 6
âœ… ì„ë² ë”© shape: torch.Size([6, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6172, 0.7458, 0.4803, 0.5228, 0.4329],
        [0.6172, 1.0000, 0.6136, 0.5831, 0.6261, 0.6105],
        [0.7458, 0.6136, 1.0000, 0.5744, 0.5678, 0.3627],
        [0.4803, 0.5831, 0.5744, 1.0000, 0.6717, 0.4407],
        [0.5228, 0.6261, 0.5678, 0.6717, 1.0000, 0.4269],
        [0.4329, 0.6105, 0.3627, 0.4407, 0.4269, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20221102.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.7131, 0.6209, 0.6590],
        [0.7131, 1.0000, 0.6607, 0.5981],
        [0.6209, 0.6607, 1.0000, 0.5448],
        [0.6590, 0.5981, 0.5448, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20221103.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.5767, 0.4940, 0.6083],
        [0.5767, 1.0000, 0.6487, 0.6985],
        [0.4940, 0.6487, 1.0000, 0.7276],
        [0.6083, 0.6985, 0.7276, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20230602.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6663, 0.3987, 0.6382, 0.5357],
        [0.6663, 1.0000, 0.5582, 0.7557, 0.7417],
        [0.3987, 0.5582, 1.0000, 0.5128, 0.4355],
        [0.6382, 0.7557, 0.5128, 1.0000, 0.7906],
        [0.5357, 0.7417, 0.4355, 0.7906, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20230603.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.7030, 0.6380, 0.6605, 0.5660],
        [0.7030, 1.0000, 0.6578, 0.6396, 0.7281],
        [0.6380, 0.6578, 1.0000, 0.6068, 0.7070],
        [0.6605, 0.6396, 0.6068, 1.0000, 0.6015],
        [0.5660, 0.7281, 0.7070, 0.6015, 1.0000]])


ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20230902.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6490, 0.7428, 0.7231, 0.6195],
        [0.6490, 1.0000, 0.7807, 0.6901, 0.6555],
        [0.7428, 0.7807, 1.0000, 0.8278, 0.7530],
        [0.7231, 0.6901, 0.8278, 1.0000, 0.7035],
        [0.6195, 0.6555, 0.7530, 0.7035, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20230903.txt
âœ… ë¬¸ì¥ ìˆ˜: 5
âœ… ì„ë² ë”© shape: torch.Size([5, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.7548, 0.5604, 0.5919, 0.8445],
        [0.7548, 1.0000, 0.5755, 0.6178, 0.7843],
        [0.5604, 0.5755, 1.0000, 0.6945, 0.5921],
        [0.5919, 0.6178, 0.6945, 1.0000, 0.6417],
        [0.8445, 0.7843, 0.5921, 0.6417, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20231102.txt
âœ… ë¬¸ì¥ ìˆ˜: 4
âœ… ì„ë² ë”© shape: torch.Size([4, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.6506, 0.6275, 0.5043],
        [0.6506, 1.0000, 0.4096, 0.4008],
        [0.6275, 0.4096, 1.0000, 0.6917],
        [0.5043, 0.4008, 0.6917, 1.0000]])

ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘: 20231103.txt
âœ… ë¬¸ì¥ ìˆ˜: 9
âœ… ì„ë² ë”© shape: torch.Size([9, 1024])
ğŸ§  ìœ ì‚¬ë„ í–‰ë ¬:
tensor([[1.0000, 0.7117, 0.6342, 0.5277, 0.3980, 0.5325, 0.4574, 0.3393, 0.5886],
        [0.7117, 1.0000, 0.6037, 0.5477, 0.4256, 0.5068, 0.4549, 0.4600, 0.5716],
        [0.6342, 0.6037, 1.0000, 0.5805, 0.5419, 0.6542, 0.5677, 0.4035, 0.6029],
        [0.5277, 0.5477, 0.5805, 1.0000, 0.5707, 0.5283, 0.5408, 0.4779, 0.6881],
        [0.3980, 0.4256, 0.5419, 0.5707, 1.0000, 0.6815, 0.6311, 0.6221, 0.5175],
        [0.5325, 0.5068, 0.6542, 0.5283, 0.6815, 1.0000, 0.6696, 0.5200, 0.6310],
        [0.4574, 0.4549, 0.5677, 0.5408, 0.6311, 0.6696, 1.0000, 0.4532, 0.5759],
        [0.3393, 0.4600, 0.4035, 0.4779, 0.6221, 0.5200, 0.4532, 1.0000, 0.4912],
        [0.5886, 0.5716, 0.6029, 0.6881, 0.5175, 0.6310, 0.5759, 0.4912, 1.0000]])
        """
# 2) ---------------------------------------------------------------
def mean_offdiag(mat: torch.Tensor) -> float:
    """ëŒ€ê°ì„ ì„ ëº€ í‰ê·  ìœ ì‚¬ë„ ê³„ì‚°"""
    n = mat.size(0)
    return ((mat.sum() - mat.trace()) / (n * (n - 1))).item()

rows = []

# 3) ë¡œê·¸ë¥¼ "ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘:" ë‹¨ìœ„ë¡œ ë¶„í• 
sections = re.split(r'ğŸ“„ íŒŒì¼ ì²˜ë¦¬ ì¤‘:', log)
for sec in sections[1:]:  # ì²« ë²ˆì§¸ëŠ” í—¤ë” ì „ ê³µë°±ì´ë¯€ë¡œ ê±´ë„ˆëœ€
    lines = sec.strip().splitlines()
    # ì²« ì¤„ì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
    header = lines[0].strip()
    file_id = header.replace('.txt', '')

    # í•´ë‹¹ ì„¹ì…˜ì—ì„œ 'tensor([['ë¡œ ì‹œì‘í•˜ëŠ” í–‰ë ¬ ë¸”ë¡ ì¶”ì¶œ
    tensor_match = re.search(r'tensor\(\[\[(.*?)\]\]\)', sec, re.DOTALL)
    if not tensor_match:
        continue
    matrix_block = tensor_match.group(1)

    # ê° í–‰ ë¬¸ìì—´ë“¤ì„ ì¶”ì¶œí•˜ê³  ìˆ«ìë¡œ ë³€í™˜
    row_strs = re.findall(r'\[([^\]]+)\]', matrix_block)
    mat_rows = []
    for row in row_strs:
        nums = [float(x) for x in re.findall(r'\d+(?:\.\d+)?', row)]
        if nums:
            mat_rows.append(nums)

    if not mat_rows:
        continue

    mat = torch.tensor(mat_rows)
    rows.append({'file': file_id, 'mean_sim': mean_offdiag(mat)})

# 4) DataFrame ìƒì„±
df = pd.DataFrame(rows)
print(df)

# 5) ì—‘ì…€ ë˜ëŠ” CSVë¡œ ì €ì¥
output_xlsx = 'mean_similarity_summary.xlsx'
output_csv = 'mean_similarity_summary.csv'
try:
    # openpyxlì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ImportError ë°œìƒ
    import openpyxl  # noqa
    df.to_excel(output_xlsx, index=False)
    print(f"âœ”ï¸ '{output_xlsx}' ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
except ImportError:
    df.to_csv(output_csv, index=False)
    print(f"âœ”ï¸ 'openpyxl' íŒ¨í‚¤ì§€ê°€ ì—†ì–´ CSVë¡œ ì €ì¥: '{output_csv}'")
